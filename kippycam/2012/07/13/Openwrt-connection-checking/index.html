<!DOCTYPE HTML>
<html lang="en">
<!-- Set up & clean variables --><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Joris Pragt’s site – Keeping Openwrt online using DHCP</title>
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../../../../default.css" media="screen">
<!--[if IE]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><link rel="alternate" type="application/rss+xml" title="Pragtich blog
    feed" href="http://pragti.ch/atom.xml">
</head>
<body>
  <titleframe><titlebar><div id="largetitle"> <a href="../../../../../">Pragtich</a>
	  </div>

	  <div id="secnav">
	  </div>
	  <div id="artnav">
	  </div> 
	</titlebar>
  </titleframe>
<article>
  <header>
	<hgroup>
	  
	  <h1 class="itemtitle">Keeping Openwrt online using DHCP</h1>
      <h2 class="itemdate">13 Jul 2012</h2>
	</hgroup>
  </header>
  <summary>
	When Openwrt loses its connection, it does not very gracefully reconnect when using proto dhcp. This is how I solved this
</summary>
<bodytext>
  <p>I noticed, when
<a href="network-layout.html">installing the WiFi network bridge to the garden shed</a>,
that the DHCP client does not reconnect when the connection has been
lost. It just sits there (don&#39;t know when it would reconnect, maybe
when the lease expires?) unconnected. For my purpose, that&#39;s not very
satisfying, as I need the connection to be robust. </p>

<p>Since I had worked with <code>monit</code> before, I figured this would be a
great way to periodically check the state of the connection and
re-enable it when it has dropped out. At a later date, <code>monit</code> could
also turn out to be helpful in making sure that all other services on
the router remain healthy. </p>

<h1>Installing &amp; configuring</h1>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>opkg update

# I am getting the packages from my local copy of the trunk, just
to have it all be consistent. That probably is only critical for
the kernel modules packages, but let&#39;s do it for sake of
simplicity

opkg install monit

vi /etc/monitrc
</code></pre></div>
<p>I added some sensible settings from the template that is in
<code>/etc/monitrc</code>, mainly to start as a daemon, put the work files in
<code>/tmp</code> and set the frequency of the checks. And the check for a
connection:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>check host kiprouter with address 10.0.0.4                                     
    if failed icmp type echo count 3 with timeout 3 seconds then
    exec &quot;/etc/init.d/network restart&quot;
</code></pre></div>
<p>Then to enable and start monit:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>/etc/init.d/monit enable
/etc/init.d/monit start
</code></pre></div>
<p>Testing results later...</p>

<footer>
  <p>
<h1>Possibly related posts:</h1>
  	  
<reftitle><a href="/computer%20stuff/2012/09/22/OpenWRT-on-the-TL-WR703N/">Installing OpenWRT on a TL-WR703N router using a USB stick as storage </a>
	  
      <h2 class="itemdate">22 Sep 2012</h2>
</reftitle>

<reftitle><a href="/kippycam/2012/08/15/Adding-an-I2C-interface-to-the-TL-WR703N/">Adding an I2C interface to the TL-WR703N </a>
	  
<img src="http://www.pragti.ch/indeximages/index-i2c.jpg">

      <h2 class="itemdate">15 Aug 2012</h2>
</reftitle>

<reftitle><a href="/computer%20stuff/2012/12/15/GNU-Emacs-24/">Switching to GNU Emacs 24 on Mac OS X </a>
	  
<img src="http://www.pragti.ch/indeximages/emacs.jpg">

      <h2 class="itemdate">15 Dec 2012</h2>
</reftitle>

<reftitle><a href="/kippycam/2012/06/22/Network-layout/">Getting network access in the garden </a>
	  
      <h2 class="itemdate">22 Jun 2012</h2>
</reftitle>

<reftitle><a href="/blogging/2013/02/03/migrating-from-nanoc-to-jekyll/">Migrating from nanoc to jekyll </a>
	  
<img src="http://www.pragti.ch/indeximages/jekyll.jpg">

      <h2 class="itemdate">03 Feb 2013</h2>
</reftitle>


  </p>
  <div id="disqus_thread"></div>
  <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'pragtich'; // required: replace example with your forum shortname
  var disqus_identifier = 'openwrt-monit';
            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
  </script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span>
  </a>
</footer>
</article>
  
<nav>
    <h2>All articles</h2> 
	<ul>
	  <li>
		<a href="http://www.pragti.ch/blog/index.html">Index of all articles</a> </li>

	</ul>
	<H2>Categories</h2>
    <ul>
	  
	    <li>
		  <a href="http://www.pragti.ch/categories/computer-stuff">Computer stuff</a>
		</li>

	  
	    <li>
		  <a href="http://www.pragti.ch/categories/life">Life</a>
		</li>

	  
	    <li>
		  <a href="http://www.pragti.ch/categories/kippycam">Kippycam</a>
		</li>

	  
	    <li>
		  <a href="http://www.pragti.ch/categories/blogging">Blogging</a>
		</li>

	  
	    <li>
		  <a href="http://www.pragti.ch/categories/project-euler">Project Euler</a>
		</li>

	  
	    <li>
		  <a href="http://www.pragti.ch/categories/mechanical">Mechanical</a>
		</li>

	  
    </ul>
	<h2>About</h2>
    <ul>
	  <li><a href="../../../../../about/">About me</a></li>
  </ul>
  </nav>
</body>
</html>
